`timescale 1ns / 1ps
//////////////////////////////////////////////////////////////////////////////////
// Company: 
// Engineer: 
// 
// Create Date: 11/27/2025 12:20:33 AM
// Design Name: 
// Module Name: control_unit
// Project Name: 
// Target Devices: 
// Tool Versions: 
// Description: 
// 
// Dependencies: 
// 
// Revision:
// Revision 0.01 - File Created
// Additional Comments:
// 
//////////////////////////////////////////////////////////////////////////////////


module control_unit(
        input CLK_IN,
        input [31:0] IR_IN,
        input [1:0] CYCLE_IN,
        input [23:0] PC_IN,
        input [31:0] REG_A_IN,
        input [31:0] REG_B_IN,
        input [31:0] MDR_IN,
        input [31:0] ACC_IN,
        input [31:0] AUX_IN,
        input [31:0] FLAGS_IN,
        output [3:0] ALU_OP_OUT,
        output MEM_WRITE_ENABLE,
        output MDR_MEM_READ_ENABLE,
        output MAR_CLEAR_ENABLE,
        output MDR_CLEAR_ENABLE,
        output REG_CLEAR_ENABLE,
        output REG_WRITE_ENABLE_OUT,
        output ALU_ENABLE,
        output MAR_WRITE_ENABLE,
        output MDR_WRITE_ENABLE,
        output MDR_READ_ENABLE,
        output [31:0] ALU_OPER_1_OUT,
        output [31:0] ALU_OPER_2_OUT,
        output [31:0] MDR_OUT,
        output [31:0] REG_WRITE_DATA_OUT,
        output [23:0] PC_DATA_OUT,
        output [23:0] MAR_OUT,
        output [4:0] REG_WRITE_SELECTOR_OUT,
        output [4:0] REG_READ_A_SELECTOR_OUT,
        output [4:0] REG_READ_B_SELECTOR_OUT,
        output BOOTSTRAP_STATE,
        output NEXT_INSTRUCTION_TRIGGER,
        output PC_WRITE_ENABLE
    );
    
    reg [23:0] ROM [8:0];
    
    initial begin
         ROM[9'b001000010] = 25'b0001110000000000000000000;
         ROM[9'b011000010] = 25'b0000001100010000000000000;
         ROM[9'b001000011] = 25'b0001110000000000000000000;
         ROM[9'b011000011] = 25'b0000001100010000000000000;
         ROM[9'b001000100] = 25'b0001110000000000000000000;
         ROM[9'b011000100] = 25'b0000001100010000000000000;
         ROM[9'b001000101] = 25'b0001110000000000000000000;
         ROM[9'b011000101] = 25'b0000001100010000000000000;
         ROM[9'b001000110] = 25'b0001110000000000000000000;
         ROM[9'b011000110] = 25'b0000001100010000000000000;
         ROM[9'b001010000] = 25'b0001010000000000000000000;
         ROM[9'b011010000] = 25'b0000001100010000000000000;
         ROM[9'b001010001] = 25'b0001010000000000000000000;
         ROM[9'b011010001] = 25'b0000001100010000000000000;
         ROM[9'b001010010] = 25'b0001010000000000000000000;
         ROM[9'b011010010] = 25'b0000001100010000000000000;
         ROM[9'b001010011] = 25'b0001010000000000000000000;
         ROM[9'b011010011] = 25'b0000001100010000000000000;
         ROM[9'b001010100] = 25'b0001010000000000000000000;
         ROM[9'b011010100] = 25'b0000001100010000000000000;
         ROM[9'b001010101] = 25'b0001010000000000000000000;
         ROM[9'b011010101] = 25'b0000001100010000000000000;
         ROM[9'b001010110] = 25'b0001010000000000000000000;
         ROM[9'b011010110] = 25'b0000001100010000000000000;
         ROM[9'b001100101] = 25'b0001110000000000000000000;
         ROM[9'b011100101] = 25'b0000000100000000000000000;
         ROM[9'b000100000] = 25'b0000010000000010000010000;
         ROM[9'b010100000] = 25'b0000000100000000000000000;
         ROM[9'b000100001] = 25'b0000000000000010000011010;
         ROM[9'b010100001] = 25'b0000000100000000000000000;
         ROM[9'b000100010] = 25'b0000000000000010000011001;
         ROM[9'b010100010] = 25'b0000000100000000000000000;
         ROM[9'b000100011] = 25'b0000000000000010000011000;
         ROM[9'b010100011] = 25'b0000000100000000000000000;
         ROM[9'b000100100] = 25'b0000000000000010000010111;
         ROM[9'b010100100] = 25'b0000000100000000000000000;
         ROM[9'b000100101] = 25'b0000000000000010000010110;
         ROM[9'b010100101] = 25'b0000000100000000000000000;
         ROM[9'b000100110] = 25'b0000000000000010000010101;
         ROM[9'b010100110] = 25'b0000000100000000000000000;
         ROM[9'b000100111] = 25'b0000000000000010000010100;
         ROM[9'b010100111] = 25'b0000000100000000000000000;
         ROM[9'b000101000] = 25'b0000000000000010000010011;
         ROM[9'b010101000] = 25'b0000000100000000000000000;
         ROM[9'b000101001] = 25'b0000000000000010000010010;
         ROM[9'b010101001] = 25'b0000000100000000000000000;
         ROM[9'b000101010] = 25'b0000000000000010000010001;
         ROM[9'b010101010] = 25'b0000000100000000000000000;
         ROM[9'b000110000] = 25'b0000000000000010010010000;
         ROM[9'b010110000] = 25'b0000000100000000000000000;
         ROM[9'b000110001] = 25'b0000000000000010010011010;
         ROM[9'b010110001] = 25'b0000000100000000000000000;
         ROM[9'b000110010] = 25'b0000000000000010010011001;
         ROM[9'b010110010] = 25'b0000000100000000000000000;
         ROM[9'b000110011] = 25'b0000000000000010010011000;
         ROM[9'b010110011] = 25'b0000000100000000000000000;
         ROM[9'b000110100] = 25'b0000000000000010010010111;
         ROM[9'b010110100] = 25'b0000000100000000000000000;
         ROM[9'b000110101] = 25'b0000000000000010010010110;
         ROM[9'b010110101] = 25'b0000000100000000000000000;
         ROM[9'b000110110] = 25'b0000000000000010010010101;
         ROM[9'b010110110] = 25'b0000000100000000000000000;
         ROM[9'b000110111] = 25'b0000000000000010010010100;
         ROM[9'b010110111] = 25'b0000000100000000000000000;
         ROM[9'b000111000] = 25'b0000000000000010010010011;
         ROM[9'b010111000] = 25'b0000000100000000000000000;
         ROM[9'b000111001] = 25'b0000000000000010010010010;
         ROM[9'b010111001] = 25'b0000000100000000000000000;
         ROM[9'b000111010] = 25'b0000000000000010010010001;
         ROM[9'b010111010] = 25'b0000000100000000000000000;
         ROM[9'b001100000] = 25'b1010100000000000000000000;
         ROM[9'b011100000] = 25'b1100000000000000000000000;
         ROM[9'b101100000] = 25'b0000001100001000000000000;
         ROM[9'b001100001] = 25'b0110110000000000000000000;
         ROM[9'b011100001] = 25'b0000000000000000001000000;
         ROM[9'b101100001] = 25'b0000000100000000000000000;
         ROM[9'b001100011] = 25'b0000000010000000000000000;
         ROM[9'b011100011] = 25'b0000001100000000100000000;
         ROM[9'b001100100] = 25'b0000011100000001000000000;
    end
    wire [24:0] INSTRUCTION_SIGNALS = ROM[{IR_IN[6:0], CYCLE_IN }];
    wire [14:0] AGU_OFFSET_15 = IR_IN[31:17];
    wire [15:0] AGU_OFFSET_16 = IR_IN[31:16];
    wire [23:0] AGU_BASE_24 = (INSTRUCTION_SIGNALS[4]) ? REG_A_IN[23:0] : REG_B_IN[23:0];
    wire [31:0] CHOSEN_INPUT_REG_WRITE = (INSTRUCTION_SIGNALS[13:12] == 0) ? REG_B_IN : (INSTRUCTION_SIGNALS[13:12] == 1) ? MDR_IN : (INSTRUCTION_SIGNALS[13:12] == 2) ?  ACC_IN : AUX_IN;
    wire [23:0] MAR_AGU_OUT = AGU_BASE_24 + (INSTRUCTION_SIGNALS[10] == 1) ? AGU_OFFSET_16 : AGU_OFFSET_15;
    wire [3:0] condition = INSTRUCTION_SIGNALS[3:0];
    wire LEU, LTU, GEU, GTU, GT, GTE, EQ, NE, LT, LTE;
    wire FLAGS_XOR_1_2 = FLAGS_IN[1] ^ FLAGS_IN[2];
    wire condition_status;
    wire READ_B_ENABLE = INSTRUCTION_SIGNALS[20];
    assign LEU = FLAGS_IN[0] | FLAGS_IN[3];
    assign LTU = FLAGS_IN[0];
    assign GEU = !FLAGS_IN[0];
    assign GTU = !FLAGS_IN[0] & !FLAGS_IN[3];
    assign GT = !FLAGS_XOR_1_2 & !FLAGS_IN[3];
    assign GTE = !FLAGS_XOR_1_2;
    assign EQ = !FLAGS_IN[3];
    assign NE = FLAGS_IN[3];
    assign LT = FLAGS_XOR_1_2;
    assign LTE = FLAGS_XOR_1_2 | FLAGS_IN[3];
    assign condition_status =   (condition == 4'd1) ? GTU : 
                                (condition == 4'd2) ? GEU :
                                (condition == 4'd3) ? LTU :
                                (condition == 4'd4) ? LEU :
                                (condition == 4'd5) ? GTE :
                                (condition == 4'd6) ? GT  :
                                (condition == 4'd7) ? LT  :
                                (condition == 4'd8) ? LTE :
                                (condition == 4'd9) ? NE :
                                (condition == 4'd10) ? EQ : 1;
    assign ALU_OP_OUT = IR_IN[3:0];
    assign ALU_OPER_1_OUT = REG_A_IN;
    assign ALU_OPER_2_OUT = (READ_B_ENABLE) ? REG_B_IN : {12'd0, IR_IN[31:12]};
    assign MDR_OUT = REG_A_IN;
    assign REG_WRITE_SELECTOR_OUT = IR_IN[11:7];
    assign REG_READ_A_SELECTOR_OUT = IR_IN[11:7];
    assign REG_READ_B_SELECTOR_OUT = IR_IN[16:12];
    assign REG_WRITE_DATA_OUT = (INSTRUCTION_SIGNALS[9:8] == 2'd0) ?  CHOSEN_INPUT_REG_WRITE : (INSTRUCTION_SIGNALS[9:8] == 2'd1) ? {IR_IN[27:12], 11'd0} : !REG_A_IN;
    assign MAR_OUT = MAR_AGU_OUT;
    assign PC_DATA_OUT = (INSTRUCTION_SIGNALS[7] == 1) ? PC_IN + AGU_OFFSET_15 : MAR_AGU_OUT;
    
    assign MEM_WRITE_ENABLE = INSTRUCTION_SIGNALS[6];
    assign MDR_MEM_READ_ENABLE = INSTRUCTION_SIGNALS[11];
    
    assign MAR_CLEAR_ENABLE = INSTRUCTION_SIGNALS[14];
    assign MDR_CLEAR_ENABLE = INSTRUCTION_SIGNALS[15];
    assign REG_CLEAR_ENABLE = INSTRUCTION_SIGNALS[16];
    assign PC_WRITE_ENABLE = !INSTRUCTION_SIGNALS[5] & condition_status & INSTRUCTION_SIGNALS[10];
    assign NEXT_INSTRUCTION_TRIGGER = !INSTRUCTION_SIGNALS[5] & INSTRUCTION_SIGNALS[17];
    assign REG_WRITE_ENABLE_OUT = INSTRUCTION_SIGNALS[18];
    
    assign ALU_ENABLE = INSTRUCTION_SIGNALS[21];
    assign MAR_WRITE_ENABLE = INSTRUCTION_SIGNALS[22];
    assign MDR_WRITE_ENABLE = INSTRUCTION_SIGNALS[23];
    assign MDR_READ_ENABLE = INSTRUCTION_SIGNALS[24];
endmodule
